# SuperChat V3 Specification

## Overview

V3 adds advanced channel features and privacy features. All V3 features maintain backward compatibility with V1/V2 clients.

**V3 Status:** In Progress (2/4 features complete)

---

## V3 Feature List

### 1. Subchannels ✅
**Status:** Complete
**Priority:** High

**Implementation Summary:**
- Two-level channel hierarchy using `parent_id` on Channel table (subchannels are channels with a parent)
- Permission check: only channel owner or server admin can create subchannels
- Terminal client: expandable tree UI in channel sidebar
- Desktop client: needs update (uses same protocol)

**Protocol Messages Implemented:**
- Client → Server: `CREATE_SUBCHANNEL (0x08)`, `GET_SUBCHANNELS (0x15)`
- Server → Client: `SUBCHANNEL_CREATED (0x88)`, `SUBCHANNEL_LIST (0x96)`
- `CHANNEL_LIST` updated with `HasSubchannels` and `SubchannelCount` fields

**Database Migration:**
```sql
-- 010_add_subchannels.sql
ALTER TABLE Channel ADD COLUMN parent_id INTEGER REFERENCES Channel(id) ON DELETE CASCADE;
CREATE INDEX IF NOT EXISTS idx_channel_parent ON Channel(parent_id) WHERE parent_id IS NOT NULL;
```

**Files Modified:**

*Server:*
- `pkg/database/migrations/010_add_subchannels.sql` - Add parent_id to Channel
- `pkg/database/database.go` - CreateSubchannel, GetSubchannels, GetSubchannelCount, updated ListChannels/GetChannel
- `pkg/database/memdb.go` - Same operations with in-memory caching
- `pkg/server/handlers.go` - handleCreateSubchannel, handleGetSubchannels, broadcastSubchannelCreated
- `pkg/server/server.go` - Message dispatch for new types

*Protocol:*
- `pkg/protocol/messages.go` - Message types (0x08, 0x15, 0x96), structs, encode/decode
- `pkg/protocol/messages_test.go` - Tests for new message types

*Terminal Client:*
- `pkg/client/ui/model.go` - expandedChannelID, subchannels state, ChannelListItem helper
- `pkg/client/ui/view.go` - Expandable tree rendering with ▸/▾ indicators
- `pkg/client/ui/update.go` - Cursor navigation, expand/collapse, subchannel handlers
- `pkg/client/ui/modal/create_subchannel.go` - Create subchannel modal
- `pkg/client/ui/modal/types.go` - ModalCreateSubchannel type

**Terminal Client UX:**
```
#general              <- regular channel, Enter → threads
#dev ▸           [3]  <- has 3 subchannels, Enter → expand
#dev ▾                <- expanded:
  #frontend           <- subchannel, Enter → threads
  #backend
  #devops
#random

Keys: Enter=expand/collapse/navigate, s=create subchannel, Esc=collapse
```

---

### 2. Direct Messages (DMs)
**Status:** Not Started
**Priority:** Medium
**Estimated Effort:** 5-7 days

**Requirements:**
- Private channels between users (not in public channel list)
- Optional end-to-end encryption
- Support for both registered and anonymous users
- Flexible key setup flow

**Key Features:**
- When starting a DM, users can choose:
  1. Set up encryption (generate/import key)
  2. Allow unencrypted now (one-time for this DM)
  3. Allow unencrypted forever (set permanent preference)

**Key Management:**
- SSH users: SSH key automatically used for encryption
- Password users: Can generate/upload public key
- Anonymous users: Can generate session-only keypair (lost on disconnect)
- Multiple keys: Server re-encrypts channel keys when new key added

**Encryption Details:**
- Each DM has unique symmetric key (AES-256)
- Symmetric key encrypted with each participant's public key
- Stored in `ChannelAccess` table (one entry per participant per channel)
- Messages encrypted with AES-256-GCM
- Anonymous users receive channel key in plaintext (no way to encrypt it persistently)

**Protocol Messages:**
- CREATE_DM (0x17) - Client → Server
- DM_CREATED (0x97) - Server → Client
- PROVIDE_PUBLIC_KEY (0x18) - Client → Server (for encryption)
- PUBLIC_KEY_RECEIVED (0x98) - Server → Client

**Database Changes:**
- Add `is_dm` flag to Channel table
- Add ChannelAccess table (channel_id, user_id, encrypted_channel_key)
- Add PublicKey table (user_id, key_type, public_key)

**Files to Create/Modify:**
- `pkg/database/migrations/007_add_direct_messages.sql`
- `pkg/protocol/messages.go` - DM protocol messages
- `pkg/server/handlers.go` - DM creation and key management
- `pkg/client/ui/` - DM UI, encryption setup flow

---

### 3. End-to-End Encryption
**Status:** Not Started
**Priority:** Medium
**Estimated Effort:** Included in DM implementation

**Requirements:**
- AES-256-GCM for message encryption
- RSA/Ed25519 for key exchange
- Per-channel symmetric keys
- Key rotation support

**Security Considerations:**
- Use established libraries (Go's `crypto` package)
- Proper random number generation for keys/nonces
- Secure key exchange using public key cryptography
- Never log private message content
- Implement proper key storage (encrypted at rest)

**See:** Direct Messages feature (encryption is part of DM implementation)

---

### 4. Message Compression
**Status:** Not Started
**Priority:** Low
**Estimated Effort:** 1-2 days

**Requirements:**
- Compress payloads > 512 bytes
- Use LZ4 for compression
- Compress before encryption (if both are used)
- Flags byte already supports compression bit

**Protocol Impact:**
- No new protocol messages needed
- Uses existing flags byte (bit 0 = compression)
- Client and server must both support compression

**Files to Modify:**
- `pkg/protocol/frame.go` - Add compression/decompression
- Server and client handlers - Detect and handle compressed frames

---

### 5. Web Client ✅
**Status:** Complete
**Priority:** Medium
**Implemented:** Desktop app with Wails (superchat-desktop/)

The web/desktop client was implemented using Wails with a React/TypeScript frontend, providing a native desktop experience while leveraging web technologies.

---

## Implementation Priority

**Recommended order:**

1. ~~**Subchannels**~~ ✅ Complete

2. **Direct Messages + Encryption** (most complex)
   - Multiple database changes
   - Key management system
   - Encryption implementation
   - Complex UI flows

3. **Message Compression** (optional, low priority)
   - Performance optimization
   - Simple implementation

**Remaining V3 features: 2 (DMs, Compression)**

---

## Database Schema Changes (V3)

### Migrations

- **010_add_subchannels.sql** ✅ - Add parent_id to Channel table
- **011_add_direct_messages.sql** - ChannelAccess, PublicKey tables, Channel.is_dm flag (planned)
- Message compression requires no schema changes (protocol-level only)

---

## Testing Requirements

All V3 features must meet coverage requirements:
- Protocol package: 90%+ coverage (enforced)
- Server package: 80-90% coverage
- Encryption: 95%+ coverage (security-critical)
- Database migrations: Path tests validating data integrity

**Migration tests must include:**
- Schema validation (tables, indexes, constraints)
- Data integrity validation (existing data preserved)
- Upgrade path testing (v2→v3)
- Encryption key migration if applicable

---

## Security Considerations

V3 introduces encryption and private messaging:

1. **Encryption:**
   - Validate all string inputs for length and content
   - Use established crypto libraries (Go's `crypto` package)
   - Proper random number generation for keys/nonces
   - Secure key storage (encrypted at rest)
   - Never log encrypted message content or keys

2. **Direct Messages:**
   - Access control (only participants can read DMs)
   - Prevent DM spam (rate limiting on DM creation)
   - Key verification (prevent MITM attacks)

3. **Key Management:**
   - Support key rotation
   - Handle compromised keys gracefully
   - Allow users to revoke keys
   - Multiple keys per user for device management

---

## Client UI Updates Needed (V3)

**Subchannels:** ✅ Complete (terminal client)
- Channel sidebar: expandable tree with ▸/▾ indicators
- Subchannel creation modal (channel owner/admin only)
- Desktop client needs update to match

**Direct Messages:**
- DM list view (separate from channels)
- DM creation: user search/selection
- Encryption setup flow:
  - Key generation/import UI
  - Encryption preference (always/once/never)
  - Key verification UI
- Lock icon for encrypted DMs

**Message Compression:**
- No UI changes needed (transparent to user)
- Optional: show compression indicator in debug mode

---

## V3 → V4 Boundary

**V4 features** (future, not planned yet):
- Multi-party DMs (3+ participants)
- Read receipts (opt-in)
- Typing indicators
- Message reactions
- Server-to-server federation
- Voice/video chat (out of scope - see CLAUDE.md)

---

## References

- **Protocol:** See `docs/PROTOCOL.md` for complete message specifications
- **V1 Spec:** See `docs/versions/V1.md` for V1 implementation
- **V2 Spec:** See `docs/versions/V2.md` for V2 implementation
- **Data Model:** See `docs/DATA_MODEL.md` for full database schema
- **Migrations:** See `docs/MIGRATIONS.md` for migration system guide

---

**Note:** V3 is in progress. Complete: Web/Desktop client, Subchannels. Remaining: DMs, Compression.
